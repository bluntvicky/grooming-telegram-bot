const { Scenes } = require('telegraf');
const { mainMenu } = require('../utils/keyboards');

// –°—Ü–µ–Ω–∞ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–∑—ã–≤–∞
const reviewTextScene = new Scenes.BaseScene('review-text-scene');

// –ü—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Å—Ü–µ–Ω—É –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞
reviewTextScene.enter(async (ctx) => {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ —Ä–µ–π—Ç–∏–Ω–≥
  if (!ctx.session.reviewRating) {
    await ctx.reply('–°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –∫ –≤—ã–±–æ—Ä—É —Ä–µ–π—Ç–∏–Ω–≥–∞.');
    return ctx.scene.enter('review-rating-scene');
  }
  
  await ctx.reply(
    'üìù *–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤*\n\n' +
    `–í—ã –ø–æ—Å—Ç–∞–≤–∏–ª–∏ –æ—Ü–µ–Ω–∫—É: ${ctx.session.reviewRating}‚≠ê\n\n` +
    '–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–∞—à–µ–≥–æ –æ—Ç–∑—ã–≤–∞:',
    { parse_mode: 'Markdown' }
  );
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã –≤–≤–æ–¥–∞ –æ—Ç–∑—ã–≤–∞
reviewTextScene.command('cancel', (ctx) => {
  ctx.reply('–í–≤–æ–¥ –æ—Ç–∑—ã–≤–∞ –æ—Ç–º–µ–Ω–µ–Ω', mainMenu());
  return ctx.scene.leave();
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–∑—ã–≤–∞
reviewTextScene.on('text', async (ctx) => {
  const reviewText = ctx.message.text.trim();
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞
  if (reviewText.length < 10) {
    return ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç–∑—ã–≤ (–º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤).');
  }
  
  if (reviewText.length > 500) {
    return ctx.reply('–û—Ç–∑—ã–≤ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∫—Ä–∞—Ç–∏—Ç–µ –µ–≥–æ –¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤.');
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞
  ctx.session.reviewText = reviewText;
  
  // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  await ctx.reply(
    'üì∑ *–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫ –æ—Ç–∑—ã–≤—É*\n\n' +
    '–•–æ—Ç–∏—Ç–µ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫ –≤–∞—à–µ–º—É –æ—Ç–∑—ã–≤—É?\n\n' +
    '–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ 3 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∏–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç—Ç–æ—Ç —à–∞–≥.',
    {
      parse_mode: 'Markdown',
      reply_markup: {
        inline_keyboard: [
          [{ text: '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç—Ç–æ—Ç —à–∞–≥', callback_data: 'skip_photos' }]
        ]
      }
    }
  );
  
  // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å—Ü–µ–Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ
  return ctx.scene.enter('review-photo-scene');
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±–æ–≥–æ –¥—Ä—É–≥–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
reviewTextScene.on('message', (ctx) => {
  return ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–≥–æ –æ—Ç–∑—ã–≤–∞.');
});

module.exports = { reviewTextScene }; 